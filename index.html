<!DOCTYPE html>

<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <script src="nav.js"></script>
        <link href="styles.css" rel="stylesheet">
        <title>Machados in London</title>
        <script> // Upcoming weather widget
            document.addEventListener('DOMContentLoaded', function() {

                // Function for converting 24h to 12h
                function displayTime(n) {
                    let time = n == 0 ? '12am'
                        : n == 12 ? '12pm'
                        : n == 24 ? '12am'
                        : n == 27 ? '3am'
                        : n < 12 ? n + 'am'
                        : n - 12 + 'pm';
                    return time;
                }

                // Function for styling icon
                function getIcon(day, forecast) {

                    let weather = forecast.weatherDesc[0].value.toLowerCase();
                    let rise = Math.floor(Number(JSON.stringify(day.astronomy[0].sunrise).substring(0, 2)) / 3) * 3;
                    let set = Math.floor((Number(JSON.stringify(day.astronomy[0].sunset).substring(0, 2)) + 12) / 3) * 3;

                    let daytime = forecast.time >= rise && forecast.time <= set ? true : false;

                    return (weather.includes("clear") || weather.includes("sunny")) && daytime ? ["bi bi-sun-fill", "color: #FFD31D"]
                        : (weather.includes("clear") || weather.includes("sunny")) && !daytime ? ["bi bi-moon-fill", "color: #626783"]
                        : weather.includes("partly") && daytime ? ["bi bi-cloud-sun", "color: #FFD31D"]
                        : weather.includes("partly") && !daytime ? ["bi bi-cloud-moon", "color: #727272"]
                        : weather.includes("cloudy") ? ["bi bi-cloudy-fill", "color: #ABABAB"]
                        : weather.includes("overcast") ? ["bi bi-clouds-fill", "color: #6F6F6F"]
                        : weather.includes("mist") || weather.includes("fog") ? ["bi bi-cloud-fog2", "color: #ABABAB"]
                        : weather.includes("thunder") ? ["bi bi-lightning-fill", "color: #FFF300"]
                        : weather.includes("freezing") || weather.includes("sleet") || weather.includes("ice") ? ["bi bi-cloud-sleet", "color: #6F6F6F"]
                        : weather.includes("snow") ? ["bi bi-cloud-snow", "color: #6F6F6F"]
                        : weather.includes("moderate") && weather.includes("rain") ? ["bi bi-cloud-rain-fill", "color: #868EBB"]
                        : weather.includes("heavy") && weather.includes("rain") ? ["bi bi-cloud-rain-heavy-fill", "color: #626783"]
                        : ["bi bi-cloud-drizzle-fill", "color: #868EBB"];
                }


                // Get weather forecast in JSON
                fetch('https://wttr.in/london?format=j1')
                .then(weatherImport => weatherImport.json())
                .then(forecast => {

                    console.log(forecast);
                    // Get current time in London
                    let hour = Math.floor((new Date().toLocaleString('en-GB', { timeZone: 'Europe/London', hour: 'numeric' })) / 3) * 3;

                    // Set values for current time
                    let i = hour / 3;
                    let day1 = forecast.weather[0];
                    let forecast1 = forecast.weather[0].hourly[i];
                    let icon1 = getIcon(day1, forecast1);

                    document.querySelector("#time-1").innerHTML = 'Now (' + displayTime(hour) + ')';
                    document.querySelector("#icon-1").setAttribute("class", icon1[0]);
                    document.querySelector("#icon-1").setAttribute("style", icon1[1]);
                    document.querySelector("#cond-1").innerHTML = forecast1.weatherDesc[0].value;
                    document.querySelector("#temp-1").innerHTML = forecast1.tempF + '°F';
                    document.querySelector("#rain-1").innerHTML = '<i class="bi bi-umbrella"></i> ' + forecast1.chanceofrain + '%';

                    // Set values for +3 hours
                    let x = hour == 21 ? 1 : 0;
                    let j = i == 7 ? 0 : i + 1;
                    let day2 = forecast.weather[x];
                    let forecast2 = forecast.weather[x].hourly[j];
                    let icon2 = getIcon(day2, forecast2);

                    document.querySelector("#time-2").innerHTML =displayTime(hour + 3);
                    document.querySelector("#icon-2").setAttribute("class", icon2[0]);
                    document.querySelector("#icon-2").setAttribute("style", icon2[1]);
                    document.querySelector("#cond-2").innerHTML = forecast2.weatherDesc[0].value;
                    document.querySelector("#temp-2").innerHTML = forecast2.tempF + '°F';
                    document.querySelector("#rain-2").innerHTML = '<i class="bi bi-umbrella"></i> ' + forecast2.chanceofrain + '%';

                    // Set values for +6 hours
                    let y = hour == 18 ? 1 : hour == 21 ? 1 : 0;
                    let k = i == 6 ? 0 : i == 7 ? 1 : i + 2;
                    let day3 = forecast.weather[y];
                    let forecast3 = forecast.weather[y].hourly[k];
                    let icon3 = getIcon(day3, forecast3);

                    document.querySelector("#time-3").innerHTML = displayTime(hour + 6);
                    document.querySelector("#icon-3").setAttribute("class", icon3[0]);
                    document.querySelector("#icon-3").setAttribute("style", icon3[1]);
                    document.querySelector("#cond-3").innerHTML = forecast3.weatherDesc[0].value;
                    document.querySelector("#temp-3").innerHTML = forecast3.tempF + '°F';
                    document.querySelector("#rain-3").innerHTML = '<i class="bi bi-umbrella"></i> ' + forecast3.chanceofrain + '%';

                    // Remove placeholders
                    document.querySelectorAll(".placeholder").forEach(function(element) {
                        element.removeAttribute("class");
                    })

                })
            })
        </script>
    </head>
    <body>
        <header>
            <div id="nav-import"></div>
        </header>
        <main>
            <img src="assets/sheepbanner.jpg" class="img-fluid" alt="The West End at night">
            <h1>Welcome to London!</h1>
            <div class="container justify-content-center text-center" id="quick-links">
                <div class="row">
                    <div class="col-lg-4">
                        <h2 class="fw-normal">
                            Nearest Train Station
                        </h2>
                        <p><a class="btn btn-secondary" href="https://www.google.com/maps/search/?api=1&query=train+station">Find</a></p>
                    </div>
                    <div class="col-lg-4">
                        <h2 class="fw-normal">
                            Nearest Bus Stop
                        </h2>
                        <p><a class="btn btn-secondary" href="https://www.google.com/maps/search/?api=1&query=bus+stop">Find</a></p>
                    </div>
                    <div class="col-lg-4 placeholder-glow">
                        <h2 class="fw-normal">
                            Upcoming Weather
                        </h2>
                        <div class="container gx-5">
                            <div class="row">
                                <div class="col">
                                    <b><span id="time-1"></span></b>
                                    <span class="placeholder col-3" aria-hidden="true"></span>
                                    <p><i id="icon-1"></i> <span id="cond-1"></span><br/><span id="temp-1"></span> <span id="rain-1"></span></p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <b><span id="time-2"></span></b>
                                    <span class="placeholder col-3" aria-hidden="true"></span><p><i id="icon-2"></i> <span id="cond-2"></span><br/><span id="temp-2"></span> <span id="rain-2"></span></p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <span class="placeholder col-3" aria-hidden="true"></span>
                                    <b><span id="time-3"></span></b>
                                    <p><i id="icon-3"></i> <span id="cond-3"></span><br/><span id="temp-3"></span> <span id="rain-3"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer>

        </footer>
    </body>
</html>
